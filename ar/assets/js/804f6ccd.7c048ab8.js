"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[6470],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>g});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),p=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),g=n,m=u["".concat(s,".").concat(g)]||u[g]||d[g]||o;return a?r.createElement(m,i(i({ref:t},c),{},{components:a})):r.createElement(m,i({ref:t},c))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},76086:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=a(87462),n=(a(67294),a(3905));const o={title:"Spring Cloud Gateway",description:"Using Casdoor in Spring Cloud Gateway",keywords:["Spring Cloud Gateway"],authors:["conghuhu"]},i=void 0,l={unversionedId:"integration/java/spring-cloud-gateway",id:"integration/java/spring-cloud-gateway",title:"Spring Cloud Gateway",description:"Using Casdoor in Spring Cloud Gateway",source:"@site/docs/integration/java/spring-cloud-gateway.md",sourceDirName:"integration/java",slug:"/integration/java/spring-cloud-gateway",permalink:"/ar/docs/integration/java/spring-cloud-gateway",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/java/spring-cloud-gateway.md",tags:[],version:"current",frontMatter:{title:"Spring Cloud Gateway",description:"Using Casdoor in Spring Cloud Gateway",keywords:["Spring Cloud Gateway"],authors:["conghuhu"]},sidebar:"tutorialSidebar",previous:{title:"Spring Cloud",permalink:"/ar/docs/integration/java/spring-cloud"},next:{title:"Spring Security",permalink:"/ar/docs/category/spring-security"}},s={},p=[{value:"Step 1: Deploy Casdoor",id:"step-1-deploy-casdoor",level:2},{value:"Step 2: Initialize a Spring Cloud Gateway",id:"step-2-initialize-a-spring-cloud-gateway",level:2},{value:"Step 3: Include the dependency",id:"step-3-include-the-dependency",level:2},{value:"Step 4: Configure your properties",id:"step-4-configure-your-properties",level:2},{value:"Step 5: Add the CasdoorAuthFilter",id:"step-5-add-the-casdoorauthfilter",level:2},{value:"Step 6: Get the Service and use it",id:"step-6-get-the-service-and-use-it",level:2},{value:"Step 7: Restart the project",id:"step-7-restart-the-project",level:2},{value:"What&#39;s more",id:"whats-more",level:2}],c={toc:p};function d(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"The ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casdoor/casdoor-springcloud-gateway-example"},"casdoor-springcloud-gateway-example")," is an example of how to use the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casdoor/casdoor-spring-boot-starter"},"casdoor-spring-boot-starter")," as an OAuth2 plugin in Spring Cloud Gateway. The steps to use it are described below."),(0,n.kt)("h2",{id:"step-1-deploy-casdoor"},"Step 1: Deploy Casdoor"),(0,n.kt)("p",null,"Firstly, Casdoor should be deployed. You can refer to the official Casdoor documentation for the ",(0,n.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Server Installation"),". Please deploy your Casdoor instance in ",(0,n.kt)("strong",{parentName:"p"},"production mode"),"."),(0,n.kt)("p",null,"After a successful deployment, you need to ensure the following:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Open your favorite browser and visit ",(0,n.kt)("strong",{parentName:"li"},(0,n.kt)("a",{parentName:"strong",href:"http://localhost:8000"},"http://localhost:8000")),". You will see the login page of Casdoor."),(0,n.kt)("li",{parentName:"ul"},"Input ",(0,n.kt)("inlineCode",{parentName:"li"},"admin")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"123")," to test if the login functionality is working fine.")),(0,n.kt)("p",null,"After that, you can quickly implement a Casdoor-based login page in your own app using the following steps."),(0,n.kt)("h2",{id:"step-2-initialize-a-spring-cloud-gateway"},"Step 2: Initialize a Spring Cloud Gateway"),(0,n.kt)("p",null,"You can use the code from this example directly or combine it with your own business code."),(0,n.kt)("p",null,"You need a gateway service and at least one business service. In this example, ",(0,n.kt)("inlineCode",{parentName:"p"},"casdoor-gateway")," is the gateway service and ",(0,n.kt)("inlineCode",{parentName:"p"},"casdoor-api")," is the business service."),(0,n.kt)("h2",{id:"step-3-include-the-dependency"},"Step 3: Include the dependency"),(0,n.kt)("p",null,"Add the ",(0,n.kt)("inlineCode",{parentName:"p"},"casdoor-spring-boot-starter")," dependency to your Spring Cloud Gateway project."),(0,n.kt)("p",null,"For Apache Maven:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-xml",metastring:'title="/casdoor-gateway/pom.xml"',title:'"/casdoor-gateway/pom.xml"'},"\x3c!-- https://mvnrepository.com/artifact/org.casbin/casdoor-spring-boot-starter --\x3e\n<dependency>\n    <groupId>org.casbin</groupId>\n    <artifactId>casdoor-spring-boot-starter</artifactId>\n    <version>1.x.y</version>\n</dependency>\n")),(0,n.kt)("p",null,"For Gradle:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-groovy"},"// https://mvnrepository.com/artifact/org.casbin/casdoor-spring-boot-starter\nimplementation group: 'org.casbin', name: 'casdoor-spring-boot-starter', version: '1.x.y'\n")),(0,n.kt)("h2",{id:"step-4-configure-your-properties"},"Step 4: Configure your properties"),(0,n.kt)("p",null,"Initialization requires 6 parameters, all of which are of type string."),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Name (in order)"),(0,n.kt)("th",{parentName:"tr",align:null},"Required"),(0,n.kt)("th",{parentName:"tr",align:null},"Description"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"endpoint"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Casdoor Server URL, such as ",(0,n.kt)("inlineCode",{parentName:"td"},"http://localhost:8000"))),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"clientId"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Application.client_id")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"clientSecret"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Application.client_secret")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"certificate"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Application.certificate")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"organizationName"),(0,n.kt)("td",{parentName:"tr",align:null},"Yes"),(0,n.kt)("td",{parentName:"tr",align:null},"Application.organization")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"applicationName"),(0,n.kt)("td",{parentName:"tr",align:null},"No"),(0,n.kt)("td",{parentName:"tr",align:null},"Application.name")))),(0,n.kt)("p",null,"You can use Java properties or YAML files to initialize these parameters."),(0,n.kt)("p",null,"For properties:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-properties"},"casdoor.endpoint=http://localhost:8000\ncasdoor.clientId=<client-id>\ncasdoor.clientSecret=<client-secret>\ncasdoor.certificate=<certificate>\ncasdoor.organizationName=built-in\ncasdoor.applicationName=app-built-in\n")),(0,n.kt)("p",null,"For YAML:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"casdoor:\n  endpoint: http://localhost:8000\n  client-id: <client-id>\n  client-secret: <client-secret>\n  certificate: <certificate>\n  organization-name: built-in\n  application-name: app-built-in\n")),(0,n.kt)("p",null,"In addition, you need to configure Gateway Routing. For YAML:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"spring:\n  application:\n    name: casdoor-gateway\n  cloud:\n    gateway:\n      routes:\n        - id: api-route\n          uri: http://localhost:9091\n          predicates:\n            - Path=/api/**\n")),(0,n.kt)("h2",{id:"step-5-add-the-casdoorauthfilter"},"Step 5: Add the CasdoorAuthFilter"),(0,n.kt)("p",null,"Add an implementation class of the GlobalFilter interface to the gateway for identity verification, such as the CasdoorAuthFilter used in this example."),(0,n.kt)("p",null,"If the authentication fails, it returns a 401 status code to the frontend to redirect them to the login interface."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class CasdoorAuthFilter implements GlobalFilter, Ordered {\n\n    private static final Logger LOGGER = LoggerFactory.getLogger(CasdoorAuthFilter.class);\n\n    @Override public int getOrder() {\n        return 0;\n    }\n\n    @Override public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        return exchange.getSession().flatMap(webSession -> {\n            CasdoorUser user = webSession.getAttribute("casdoorUser");\n            if (user != null) {\n                return chain.filter(exchange);\n            }\n            ServerHttpResponse response = exchange.getResponse();\n            response.setStatusCode(HttpStatus.UNAUTHORIZED);\n            response.getHeaders().add("Content-Type", "application/json");\n            return response.setComplete();\n        });\n    }\n}\n')),(0,n.kt)("h2",{id:"step-6-get-the-service-and-use-it"},"Step 6: Get the Service and use it"),(0,n.kt)("p",null,"Now provide 5 services: ",(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorAuthService"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorUserService"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorEmailService"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorSmsService"),", and ",(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorResourceService"),"."),(0,n.kt)("p",null,"You can create them as follows in the Gateway project."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},"@Resource\nprivate CasdoorAuthService casdoorAuthService;\n")),(0,n.kt)("p",null,"When you require authentication for accessing your app, you can send the target URL and redirect to the login page provided by Casdoor."),(0,n.kt)("p",null,"Please make sure that you have added the callback URL (e.g., ",(0,n.kt)("a",{parentName:"p",href:"http://localhost:9090/callback"},"http://localhost:9090/callback"),") in the application configuration in advance."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'@RequestMapping("login")\npublic Mono<String> login() {\n    return Mono.just("redirect:" + casdoorAuthService.getSigninUrl("http://localhost:9090/callback"));\n}\n')),(0,n.kt)("p",null,"After successful verification by Casdoor, it will be redirected back to your application with a code and state. You can get the code and call the ",(0,n.kt)("inlineCode",{parentName:"p"},"getOAuthToken")," method to parse out the JWT token."),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"CasdoorUser")," contains the basic information about the user provided by Casdoor. You can use it as a keyword to set the session in your application."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'@RequestMapping("callback")\npublic Mono<String> callback(String code, String state, ServerWebExchange exchange) {\n    String token = "";\n    CasdoorUser user = null;\n    try {\n        token = casdoorAuthService.getOAuthToken(code, state);\n        user = casdoorAuthService.parseJwtToken(token);\n    } catch(CasdoorAuthException e) {\n        e.printStackTrace();\n    }\n    CasdoorUser finalUser = user;\n    return exchange.getSession().flatMap(session -> {\n        session.getAttributes().put("casdoorUser", finalUser);\n        return Mono.just("redirect:/");\n    });\n}\n')),(0,n.kt)("p",null,"Examples of the APIs are shown below."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"CasdoorAuthService",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'String token = casdoorAuthService.getOAuthToken(code, "app-built-in");')),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorUser casdoorUser = casdoorAuthService.parseJwtToken(token);")))),(0,n.kt)("li",{parentName:"ul"},"CasdoorUserService",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'CasdoorUser casdoorUser = casdoorUserService.getUser("admin");')),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'CasdoorUser casdoorUser = casdoorUserService.getUserByEmail("admin@example.com");')),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorUser[] casdoorUsers = casdoorUserService.getUsers();")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'CasdoorUser[] casdoorUsers = casdoorUserService.getSortedUsers("created_time", 5);')),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'int count = casdoorUserService.getUserCount("0");')),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorUserService.addUser(user);")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorUserService.updateUser(user);")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorUserService.deleteUser(user);")))),(0,n.kt)("li",{parentName:"ul"},"CasdoorEmailService",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorEmailService.sendEmail(title, content, sender, receiver);")))),(0,n.kt)("li",{parentName:"ul"},"CasdoorSmsService",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorSmsService.sendSms(randomCode(), receiver);")))),(0,n.kt)("li",{parentName:"ul"},"CasdoorResourceService",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorResourceService.uploadResource(user, tag, parent, fullFilePath, file);")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CasdoorResponse response = casdoorResourceService.deleteResource(file.getName());"))))),(0,n.kt)("h2",{id:"step-7-restart-the-project"},"Step 7: Restart the project"),(0,n.kt)("p",null,"After starting the project, open your favorite browser and visit ",(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("a",{parentName:"strong",href:"http://localhost:9090"},"http://localhost:9090")),". Then click any button that requests resources from ",(0,n.kt)("inlineCode",{parentName:"p"},"casdoor-api"),"."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"index",src:a(93772).Z,width:"532",height:"405"})),(0,n.kt)("p",null,"The gateway authentication logic will be triggered. Since you are not logged in, you will be redirected to the login interface. Click the Login button."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"toLogin",src:a(93808).Z,width:"561",height:"360"})),(0,n.kt)("p",null,"You can see the unified login platform of Casdoor."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"login",src:a(31698).Z,width:"1980",height:"916"})),(0,n.kt)("p",null,"After a successful login, you will be redirected to the main interface. Now you can click any button."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"index-ok",src:a(29252).Z,width:"532",height:"415"})),(0,n.kt)("h2",{id:"whats-more"},"What's more"),(0,n.kt)("p",null,"You can explore the following projects/docs to learn more about the integration of Java with Casdoor."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/casdoor/casdoor-java-sdk"},"casdoor-java-sdk")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/casdoor/casdoor-spring-boot-starter"},"casdoor-spring-boot-starter")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/casdoor/casdoor-spring-boot-example"},"casdoor-spring-boot-example")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/docs/integration/java/spring-security/spring-security-oauth"},"casdoor-spring-security-example")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/docs/integration/java/spring-security/spring-security-filter"},"casdoor-spring-security-react-example")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/casdoor/casdoor-spring-boot-shiro-example"},"casdoor-spring-boot-shiro-example")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/casdoor/casdoor-springcloud-gateway-example"},"casdoor-springcloud-gateway-example"))))}d.isMDXComponent=!0},29252:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/index-ok-b24fb86bf6ddc7fb714b80c9091f0e8e.png"},93772:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/index-3fc15594b62cd8175f59a723f36ddd56.png"},31698:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/login-3016c9c5c5db22a0740ab7dbea15f4b5.png"},93808:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/toLogin-bd55cc3d3d9d9693d4eada85cc8c03ac.png"}}]);